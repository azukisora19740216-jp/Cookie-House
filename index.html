<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è‡ªè²©æ©Ÿã‚·ã‚¹ãƒ†ãƒ  ç·åˆç®¡ç†ãƒ¡ãƒ‹ãƒ¥ãƒ¼</title>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <!-- QRã‚³ãƒ¼ãƒ‰ãƒªãƒ¼ãƒ€ãƒ¼ç”¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒª -->
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <style>
    body {
      font-family: "Helvetica Neue", Arial, sans-serif;
      background-color: #f0f2f5;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
      color: #333;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.08);
      width: 100%;
      max-width: 450px;
      box-sizing: border-box;
      max-height: 95vh;
      overflow-y: auto;
    }
    h2 {
      margin-top: 0;
      margin-bottom: 20px;
      color: #1565c0;
      font-size: 1.4rem;
      text-align: center;
      border-bottom: 2px solid #e3f2fd;
      padding-bottom: 10px;
    }
    
    /* å…±é€šãƒœã‚¿ãƒ³è¨­å®š */
    .btn {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 100%;
      padding: 12px;
      margin-bottom: 15px;
      border: none;
      border-radius: 6px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      text-decoration: none;
      transition: all 0.2s;
      box-sizing: border-box;
      color: white;
    }
    .btn:hover { transform: translateY(-1px); box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
    .btn:active { transform: translateY(0); box-shadow: none; }
    
    .icon { margin-right: 8px; font-size: 20px; }

    /* ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒœã‚¿ãƒ³è‰² */
    .btn-input { background-color: #00796b; } 
    .btn-report { background-color: #d32f2f; } 
    .btn-back { background-color: #757575; margin-top: 20px; } 
    .btn-close { background-color: #212121; margin-top: 10px; } 

    /* ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠãƒœã‚¿ãƒ³è‰² */
    .btn-profile {
      background-color: #fff;
      color: #333;
      border: 2px solid #1565c0;
      justify-content: space-between;
      padding: 15px;
    }
    .btn-profile:hover { background-color: #e3f2fd; }
    .btn-profile .profile-name { flex-grow: 1; text-align: left; margin-left: 10px; }
    
    .btn-add { background-color: #f5f5f5; color: #555; border: 2px dashed #ccc; box-shadow: none; }
    .btn-add:hover { background-color: #e0e0e0; border-color: #aaa; box-shadow: none; }

    /* ãƒ•ã‚©ãƒ¼ãƒ å‘¨ã‚Š */
    label { font-size: 12px; color: #666; margin-bottom: 5px; display: block; font-weight: bold; }
    input[type="text"] {
      width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; margin-bottom: 15px; font-size: 14px;
    }
    .btn-save { background-color: #1565c0; color: white; margin-bottom: 10px; }
    .btn-qr { background-color: #388e3c; margin-bottom: 15px; font-size: 14px; padding: 10px; }
    .btn-qr-stop { background-color: #f57c00; margin-bottom: 15px; font-size: 14px; padding: 10px; }
    .btn-delete { background-color: #fff; color: #d32f2f; border: 1px solid #d32f2f; margin-top: 20px; }
    .btn-delete:hover { background-color: #ffebee; }

    .hidden { display: none !important; }

    /* QRãƒªãƒ¼ãƒ€ãƒ¼é ˜åŸŸ */
    #qr-reader {
      width: 100%;
      margin-bottom: 15px;
      border-radius: 8px;
      overflow: hidden;
      border: none !important;
    }

    /* è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«å…¥å‡ºåŠ›ã‚¨ãƒªã‚¢ */
    .file-ops {
      margin-top: 30px; padding-top: 15px; border-top: 1px solid #eee; display: flex; gap: 10px; justify-content: space-between;
    }
    .file-btn {
      background: none; border: none; color: #1976d2; font-size: 11px; cursor: pointer; text-decoration: underline; padding: 0;
    }
    .file-btn:hover { color: #0d47a1; }
    
    .subtitle { text-align: center; color: #666; font-size: 13px; margin-bottom: 20px; }
  </style>
</head>
<body>

  <div class="container">
    
    <!-- 1. ã‚·ã‚¹ãƒ†ãƒ é¸æŠç”»é¢ -->
    <div id="selectArea">
      <h2>ã‚·ã‚¹ãƒ†ãƒ é¸æŠ</h2>
      <div class="subtitle">æ“ä½œã™ã‚‹è‡ªè²©æ©Ÿã‚·ã‚¹ãƒ†ãƒ ã‚’é¸ã‚“ã§ãã ã•ã„</div>
      
      <div id="profileList">
        <!-- JSã§ãƒœã‚¿ãƒ³ãŒå‹•çš„ã«è¿½åŠ ã•ã‚Œã¾ã™ -->
      </div>

      <button class="btn btn-add" onclick="showSetupForm()">
        <span class="material-icons icon">add_circle_outline</span>
        æ–°ã—ã„ã‚·ã‚¹ãƒ†ãƒ ã‚’ç™»éŒ²ã™ã‚‹
      </button>

      <!-- ãƒ•ã‚¡ã‚¤ãƒ«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æ©Ÿèƒ½ -->
      <div class="file-ops">
        <button class="file-btn" onclick="exportConfig()">ğŸ“¥ è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‡ºåŠ›(ä¿å­˜)</button>
        <button class="file-btn" onclick="document.getElementById('importFile').click()">ğŸ“¤ è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­è¾¼</button>
        <input type="file" id="importFile" style="display:none" accept=".json" onchange="importConfig(event)">
      </div>
    </div>

    <!-- 2. ç®¡ç†ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç”»é¢ (é¸æŠå¾Œ) -->
    <div id="menuArea" class="hidden">
      <h2 id="menuTitle">ç®¡ç†ãƒ¡ãƒ‹ãƒ¥ãƒ¼</h2>
      
      <a href="#" id="linkInput" target="_blank" class="btn btn-input">
        <span class="material-icons icon">edit_note</span>
        ç‚¹æ¤œå…¥åŠ›ç”»é¢ã‚’é–‹ã
      </a>
      <a href="#" id="linkReport" target="_blank" class="btn btn-report">
        <span class="material-icons icon">bar_chart</span>
        æœˆæ¬¡ãƒ¬ãƒãƒ¼ãƒˆã‚’å‡ºåŠ›ã™ã‚‹
      </a>
      
      <button class="btn btn-back" onclick="backToSelect()">
        <span class="material-icons icon">arrow_back</span>
        ã‚·ã‚¹ãƒ†ãƒ é¸æŠã«æˆ»ã‚‹
      </button>

      <!-- çµ‚äº†ãƒœã‚¿ãƒ³ -->
      <button class="btn btn-close" onclick="closeMenu()">
        <span class="material-icons icon">close</span>
        ç®¡ç†ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’çµ‚äº†ã™ã‚‹
      </button>
      
      <div style="text-align:right; margin-top:15px;">
        <button class="file-btn" style="color:#666;" onclick="editCurrentProfile()">âš™ï¸ ã“ã®è¨­å®šã‚’ç·¨é›†/å‰Šé™¤</button>
      </div>
    </div>

    <!-- 3. è¨­å®šç™»éŒ²ãƒ»ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ  -->
    <div id="setupArea" class="hidden">
      <h2 id="setupTitle">ã‚·ã‚¹ãƒ†ãƒ ã®ç™»éŒ²</h2>
      
      <input type="hidden" id="editProfileId">
      
      <label>ã‚·ã‚¹ãƒ†ãƒ åï¼ˆä¾‹: ã‚¢ãƒ–ãƒ¬ã‚¤ã‚ºç‰ˆã€å‚™ä¸­ç‰ˆãªã©ï¼‰</label>
      <input type="text" id="inputName" placeholder="è¡¨ç¤ºåã‚’å…¥åŠ›" required>
      
      <label>GASã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªã®URL</label>
      
      <!-- QRã‚³ãƒ¼ãƒ‰èª­ã¿å–ã‚Šé ˜åŸŸ -->
      <button class="btn btn-qr" id="btnStartQr" onclick="startQrScanner()" type="button">
        <span class="material-icons icon">qr_code_scanner</span>
        QRã‚³ãƒ¼ãƒ‰ã§URLã‚’èª­ã¿å–ã‚‹
      </button>
      
      <button class="btn btn-qr-stop hidden" id="btnStopQr" onclick="stopQrScanner()" type="button">
        <span class="material-icons icon">stop_circle</span>
        ã‚«ãƒ¡ãƒ©ã‚’é–‰ã˜ã‚‹
      </button>

      <div id="qr-reader" class="hidden"></div>
      
      <input type="text" id="inputUrl" placeholder="https://script.google.com/macros/s/..." required>
      
      <button class="btn btn-save" onclick="saveProfile()" style="margin-top: 10px;">
        <span class="material-icons icon">save</span> ä¿å­˜ã™ã‚‹
      </button>
      <button class="btn btn-back" style="margin-top:0;" onclick="backToSelect()">
        ã‚­ãƒ£ãƒ³ã‚»ãƒ«
      </button>
      
      <button id="btnDelete" class="btn btn-delete hidden" onclick="deleteProfile()">
        <span class="material-icons icon">delete</span> ã“ã®è¨­å®šã‚’å‰Šé™¤ã™ã‚‹
      </button>
    </div>

  </div>

  <script>
    const STORAGE_KEY = 'vending_machine_profiles';
    let profiles = [];
    let currentProfileId = null;
    let html5QrcodeScanner = null; // QRã‚¹ã‚­ãƒ£ãƒŠãƒ¼ç”¨å¤‰æ•°

    // --- åˆæœŸåŒ–å‡¦ç† ---
    window.onload = function() {
      loadProfiles();
    };

    function loadProfiles() {
      const savedData = localStorage.getItem(STORAGE_KEY);
      if (savedData) {
        try {
          profiles = JSON.parse(savedData);
        } catch(e) {
          profiles = [];
        }
      } else {
        // æ—§ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‹ã‚‰ã®ãƒ‡ãƒ¼ã‚¿ç§»è¡Œ
        const oldUrl = localStorage.getItem('abraze_webapp_url');
        if (oldUrl) {
          profiles.push({ id: Date.now().toString(), name: 'ã‚¢ãƒ–ãƒ¬ã‚¤ã‚ºè‡ªè²©æ©Ÿç®¡ç†', url: oldUrl });
          saveToStorage();
          localStorage.removeItem('abraze_webapp_url'); // æ—§ã‚­ãƒ¼ã¯å‰Šé™¤
        }
      }
      renderProfileList();
      showScreen('selectArea');
    }

    function saveToStorage() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(profiles));
    }

    // --- ç”»é¢åˆ‡ã‚Šæ›¿ãˆ ---
    function showScreen(screenId) {
      document.getElementById('selectArea').classList.add('hidden');
      document.getElementById('menuArea').classList.add('hidden');
      document.getElementById('setupArea').classList.add('hidden');
      document.getElementById(screenId).classList.remove('hidden');
    }

    function backToSelect() {
      currentProfileId = null;
      stopQrScanner(); // æˆ»ã‚‹æ™‚ã«ã‚«ãƒ¡ãƒ©ãŒé–‹ã„ã¦ã„ã‚Œã°é–‰ã˜ã‚‹
      renderProfileList();
      showScreen('selectArea');
    }

    // --- ãƒ¡ãƒ‹ãƒ¥ãƒ¼çµ‚äº†å‡¦ç† ---
    function closeMenu() {
      window.close();
      setTimeout(() => {
        document.body.innerHTML = `
          <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; background-color: #f0f2f5; color: #333; font-family: sans-serif;">
            <h2 style="color: #1565c0; margin-bottom: 10px;">çµ‚äº†ã—ã¾ã—ãŸ</h2>
            <p style="color: #666; font-size: 14px;">ã“ã®ã‚¿ãƒ–ï¼ˆã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ï¼‰ã‚’é–‰ã˜ã¦ãã ã•ã„ã€‚</p>
          </div>
        `;
      }, 200);
    }

    // --- ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠãƒªã‚¹ãƒˆã®æç”» ---
    function renderProfileList() {
      const listDiv = document.getElementById('profileList');
      listDiv.innerHTML = '';
      
      profiles.forEach(prof => {
        const btn = document.createElement('button');
        btn.className = 'btn btn-profile';
        btn.innerHTML = `
          <span class="material-icons" style="color:#1565c0;">dns</span>
          <span class="profile-name">${escapeHtml(prof.name)}</span>
          <span class="material-icons" style="color:#ccc;">chevron_right</span>
        `;
        btn.onclick = () => openMenu(prof.id);
        listDiv.appendChild(btn);
      });
    }

    // --- ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç”»é¢ã‚’é–‹ã ---
    function openMenu(id) {
      const prof = profiles.find(p => p.id === id);
      if (!prof) return;
      
      currentProfileId = id;
      document.getElementById('menuTitle').textContent = prof.name;
      
      const base = prof.url.trim();
      const separator = base.includes('?') ? '&' : '?';
      
      document.getElementById('linkInput').href = base;
      document.getElementById('linkReport').href = base + separator + 'page=report';
      
      showScreen('menuArea');
    }

    // --- ç™»éŒ²ãƒ»ç·¨é›†å‡¦ç† ---
    function showSetupForm(editId = null) {
      document.getElementById('editProfileId').value = editId || '';
      document.getElementById('btnDelete').classList.toggle('hidden', !editId);
      
      if (editId) {
        const prof = profiles.find(p => p.id === editId);
        document.getElementById('setupTitle').textContent = 'è¨­å®šã®ç·¨é›†';
        document.getElementById('inputName').value = prof.name;
        document.getElementById('inputUrl').value = prof.url;
      } else {
        document.getElementById('setupTitle').textContent = 'æ–°ã—ã„ã‚·ã‚¹ãƒ†ãƒ ã®ç™»éŒ²';
        document.getElementById('inputName').value = '';
        document.getElementById('inputUrl').value = '';
      }
      showScreen('setupArea');
    }

    function editCurrentProfile() {
      showSetupForm(currentProfileId);
    }

    function saveProfile() {
      const name = document.getElementById('inputName').value.trim();
      const url = document.getElementById('inputUrl').value.trim();
      const id = document.getElementById('editProfileId').value;
      
      if (!name || !url) {
        alert('ã‚·ã‚¹ãƒ†ãƒ åã¨URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
        return;
      }
      if (!url.startsWith('https://script.google.com/')) {
        alert('æ­£ã—ã„GASã®URL(https://script.google.com/...)ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
        return;
      }

      if (id) {
        const prof = profiles.find(p => p.id === id);
        if (prof) { prof.name = name; prof.url = url; }
      } else {
        profiles.push({ id: Date.now().toString(), name: name, url: url });
      }

      saveToStorage();
      backToSelect();
    }

    function deleteProfile() {
      const id = document.getElementById('editProfileId').value;
      if (confirm('ã“ã®è¨­å®šã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) {
        profiles = profiles.filter(p => p.id !== id);
        saveToStorage();
        backToSelect();
      }
    }

    // --- QRã‚³ãƒ¼ãƒ‰ãƒªãƒ¼ãƒ€ãƒ¼æ©Ÿèƒ½ ---
    function startQrScanner() {
      document.getElementById('btnStartQr').classList.add('hidden');
      document.getElementById('btnStopQr').classList.remove('hidden');
      document.getElementById('qr-reader').classList.remove('hidden');

      html5QrcodeScanner = new Html5QrcodeScanner(
        "qr-reader", 
        { fps: 10, qrbox: { width: 250, height: 250 } }, 
        /* verbose= */ false
      );
      
      html5QrcodeScanner.render(onScanSuccess, onScanFailure);
    }

    function onScanSuccess(decodedText, decodedResult) {
      document.getElementById('inputUrl').value = decodedText;
      stopQrScanner();
      
      // ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒè¦–è¦šçš„ã«æ›´æ–°ã•ã‚ŒãŸã“ã¨ã‚’ã‚¢ãƒ”ãƒ¼ãƒ«
      const urlInput = document.getElementById('inputUrl');
      urlInput.style.backgroundColor = '#e8f5e9';
      setTimeout(() => { urlInput.style.backgroundColor = '#fff'; }, 1000);
      
      alert('QRã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿å–ã‚Šã¾ã—ãŸã€‚URLãŒå…¥åŠ›ã•ã‚Œã¾ã—ãŸã€‚');
    }

    function onScanFailure(error) {
      // èª­ã¿å–ã‚Šå¤±æ•—ã¯ç¶™ç¶šçš„ã«å‘¼ã°ã‚Œã‚‹ãŸã‚ã€ã“ã“ã§ã¯ç‰¹ã«ã‚¨ãƒ©ãƒ¼ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã¯å‡ºã•ãªã„
    }

    function stopQrScanner() {
      if (html5QrcodeScanner) {
        html5QrcodeScanner.clear().then(() => {
          document.getElementById('btnStartQr').classList.remove('hidden');
          document.getElementById('btnStopQr').classList.add('hidden');
          document.getElementById('qr-reader').classList.add('hidden');
          html5QrcodeScanner = null;
        }).catch(error => {
          console.error("ã‚«ãƒ¡ãƒ©ã®åœæ­¢ã«å¤±æ•—ã—ã¾ã—ãŸã€‚", error);
        });
      }
    }

    // --- ãƒ•ã‚¡ã‚¤ãƒ« ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ / ã‚¤ãƒ³ãƒãƒ¼ãƒˆæ©Ÿèƒ½ ---
    function exportConfig() {
      if (profiles.length === 0) {
        alert('ä¿å­˜ã™ã‚‹è¨­å®šãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
        return;
      }
      const dataStr = JSON.stringify(profiles, null, 2);
      const blob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'è‡ªè²©æ©Ÿã‚·ã‚¹ãƒ†ãƒ è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«.json';
      a.click();
      URL.revokeObjectURL(url);
    }

    function importConfig(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const imported = JSON.parse(e.target.result);
          if (Array.isArray(imported)) {
            profiles = imported;
            saveToStorage();
            renderProfileList();
            alert('è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚');
          } else {
            throw new Error('å½¢å¼ãŒé•ã„ã¾ã™');
          }
        } catch(err) {
          alert('ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ­£ã—ã„è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
        }
        event.target.value = ''; // ãƒªã‚»ãƒƒãƒˆ
      };
      reader.readAsText(file);
    }

    // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–
    function escapeHtml(str) {
      return String(str).replace(/[&<>"'`=\/]/g, function (s) {
        return { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;', '/': '&#x2F;', '=': '&#x3D;', '`': '&#x60;' }[s];
      });
    }
  </script>
</body>
</html>
